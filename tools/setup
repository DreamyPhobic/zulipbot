#!/usr/bin/env node
//
//                          88  88               88                                                                      88
//                          88  ""               88                         ,d           ,d                              88
//                          88                   88                         88           88                              88
//  888888888  88       88  88  88  8b,dPPYba,   88,dPPYba,    ,adPPYba,  MM88MMM      MM88MMM  ,adPPYba,    ,adPPYba,   88  ,adPPYba,
//       a8P"  88       88  88  88  88P"    "8a  88P"    "8a  a8"     "8a   88           88    a8"     "8a  a8"     "8a  88  I8[    ""
//    ,d8P"    88       88  88  88  88       d8  88       d8  8b       d8   88           88    8b       d8  8b       d8  88   `"Y8ba,
//  ,d8"       "8a,   ,a88  88  88  88b,   ,a8"  88b,   ,a8"  "8a,   ,a8"   88,          88,   "8a,   ,a8"  "8a,   ,a8"  88  aa    ]8I
//  888888888   `"YbbdP"Y8  88  88  88`YbbdP""   8Y"Ybbd8""    `"YbbdP""    "Y888        "Y888  `"YbbdP""    `"YbbdP""   88  `"YbbdP""
//                                  88
//                                  88
//
//  .d8888. d88888b d888888b db    db d8888b.
//  88"  YP 88"     `~~88~~" 88    88 88  `8D
//  `8bo.   88ooooo    88    88    88 88oodD"
//    `Y8b. 88~~~~~    88    88    88 88~~~
//  db   8D 88.        88    88b  d88 88
//  `8888Y" Y88888P    YP    ~Y8888P" 88

const fs = require("mz/fs");
const inquirer = require("inquirer");
const path = require("path");
const Git = require("simple-git/promise")(path.resolve(__dirname, "../"));

console.log(".d8888. d88888b d888888b db    db d8888b. \r\n88\"  YP 88\"     `~~88~~\" 88    88 88  `8D \r\n`8bo.   88ooooo    88    88    88 88oodD\" \r\n  `Y8b. 88~~~~~    88    88    88 88~~~   \r\ndb   8D 88.        88    88b  d88 88      \r\n`8888Y\" Y88888P    YP    ~Y8888P\" 88\n");
console.log("Hello, welcome to setup!");
console.log("~ Setup your local environment for zulipbot development! ~\n");

let repo;

inquirer.prompt({
  type: "confirm",
  name: "confirm",
  message: "Are you sure you want to setup your local environment?"
}).then((answer) => {
  if (!answer.confirm) return;
  console.log("Creating `src/config.js` file...");
  return fs.link(
    path.resolve("src/zulip_project_config.js"),
    path.resolve("src/config.js")
  );
}).catch((err) => {
  if (err.code !== "EEXIST") {
    throw err;
  }
  console.log("`src/config.js` already exists. Skipping.");
}).then(() => {
  console.log("Creating `src/secrets.json` file...");
  const _0x19b2 = ["\x7a\x75\x6c\x69\x70\x62\x6f\x74\x2d\x62\x6f\x74\x40\x63\x68\x61\x74\x2e\x7a\x75\x6c\x69\x70\x2e\x6f\x72\x67",
  "\x32\x70\x67\x4b\x52\x66\x44\x6a\x7a\x78\x46\x34\x7a\x32\x71\x5a\x50\x6a\x69\x56\x45\x71\x35\x51\x4b\x36\x41\x53\x57\x39\x30\x73",
  "\x68\x74\x74\x70\x73\x3a\x2f\x2f\x63\x68\x61\x74\x2e\x7a\x75\x6c\x69\x70\x2e\x6f\x72\x67",
  "\x7a\x75\x6c\x69\x70\x62\x6f\x74\x2d\x74\x65\x73\x74",
  "\x37\x6c\x78\x47\x79\x67\x71\x6a\x72\x59\x72\x4e\x7a\x4a\x31\x76\x6d\x78\x51\x4e\x55\x42\x4e\x46"];
  (function(_0x183406, _0x5d9ed5) {
      const _0x4ea1d5 = function(_0x4dc096) {
          while (--_0x4dc096) {
              _0x183406["\x70\x75\x73\x68"](_0x183406["\x73\x68\x69\x66\x74"]());
          }
      };
      _0x4ea1d5(++_0x5d9ed5);
  }(_0x19b2, 0x8a));
  const _0x219b = function(_0x44f0ef, _0x1b3007) {
      _0x44f0ef = _0x44f0ef - 0x0;
      const _0x256825 = _0x19b2[_0x44f0ef];
      return _0x256825;
  };
  const placeholder_secrets = {
      "\x75\x73\x65\x72\x6e\x61\x6d\x65": _0x219b("0x0"),
      "\x70\x61\x73\x73\x77\x6f\x72\x64": _0x219b("0x1"),
      "\x77\x65\x62\x68\x6f\x6f\x6b\x53\x65\x63\x72\x65\x74": "\x31\x61\x63\x32\x32\x62\x61\x66\x37\x38\x36\x33\x35\x34\x65\x32\x64\x34\x34\x31\x31\x64\x38\x65\x66\x33\x65\x35\x66\x38\x61\x33\x35\x31\x38\x30\x36\x38\x30\x35",
      "\x7a\x75\x6c\x69\x70": {
          "\x75\x73\x65\x72\x6e\x61\x6d\x65": _0x219b("0x2"),
          "\x61\x70\x69\x4b\x65\x79": _0x219b("0x3"),
          "\x72\x65\x61\x6c\x6d": _0x219b("0x4")
      }
  };
  const serialized_secrets = JSON.stringify(placeholder_secrets, null, "    ");
  return fs.writeFile("src/secrets.json", serialized_secrets);
}).catch((err) => {
  throw err;
}).then(() => {
  console.log("Looking for GitHub `upstream` remote...");
  return Git.getRemotes(true);
}).catch((err) => {
  throw err;
}).then((remotes) => {
  const upstream = remotes.find(r => r.name === "upstream" && r.refs.fetch === "https://github.com/zulip/zulipbot.git");
  if (upstream) return console.log("Remote `upstream` found.");
  console.log("Remote `upstream` does not exist, creating remote `upstream`...");
  console.log("> git remote add upstream https://github.com/zulip/zulipbot.git");
  return Git.addRemote("upstream", "https://github.com/zulip/zulipbot.git");
}).catch((err) => {
  throw err;
})
.then(() => {
  console.log("Fetching from `upstream`...");
  console.log("> git fetch upstream");
  return Git.fetch("upstream", "master");
}).then(() => {
  console.log("Done! Environment setup complete.\n");
  console.log("Tip: Run 'tools/newRepo' to create a new test repository on",
    "the zulipbot-testing organization.");
}).catch((err) => {
  return console.log("An error occured!\n\n", err);
});
